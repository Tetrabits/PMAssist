<div *ngIf="project">

  <div class="flex flex-row flex-wrap mb-1">
    <div class="flex mr-1">
      <p-dropdown [options]="projects" (onChange)="projectChanged($event)" optionLabel="name"></p-dropdown>
    </div>
    <div class="flex mr-1">
      <p-dropdown [options]="sprints" [(ngModel)]="selectedSprintNumber" optionLabel="number" (onChange)="sprintChanged($event)"></p-dropdown>
    </div>
    <div class="flex mr-1">
      <i *ngIf="progress===100" class="pi pi-lock text-red-500" style="font-size:1.5rem"></i>
    </div>
    <div class="flex flex-grow-1 flex-column flex-wrap">
      <div class="mr-1">
        <p-progressBar [value]="progress"></p-progressBar>
      </div>
      <div class="flex flex-row flex-wrap justify-content-between">
        <div class="flex mr-1">
          {{project.startsOn|date}}
        </div>

        <div class="flex mr-1">
          {{project.endsOn|date}}
        </div>
      </div>
    </div>
    <div class="flex align-items-center mr-1">
      <p-button label="Close Sprint" icon="pi pi-lock" iconPos="right" styleClass="p-button-sm"></p-button>
    </div>
  </div>

  <p-table [value]="da" styleClass="p-datatable-sm p-datatable-gridlines" [scrollable]="true" scrollHeight="200px">
    <ng-template pTemplate="header" let-columns>
      <tr>
        <th rowspan="2">Sprint Duration</th>
        <th rowspan="2"># Resources</th>
        <th colspan="4" class="text-center">Effort</th>
        <th colspan="6" class="text-center">#Story</th>
        <th colspan="4" class="text-center">Story Point</th>
        <th colspan="2" class="text-center">Code Review</th>
        <th colspan="4" class="text-center">Defects</th>
        <th rowspan="2">% Unit Test Coverage</th>
      </tr>
      <tr>
        <th>Capacity</th>
        <th>Planned</th>
        <th>Actual</th>
        <th>Rework</th>
        <th>Planned</th>
        <th>Baselined</th>
        <th>Delivered</th>
        <th>Accepted</th>
        <th>QA Tested</th>
        <th>Modified</th>
        <th>Planned</th>
        <th>Baselined</th>
        <th>Delivered</th>
        <th>Accepted</th>
        <th>Internal</th>
        <th>External</th>
        <th>QA</th>
        <th>UAT</th>
        <th>Production</th>
        <th>Reopened</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-da>
      <tr>
        <td class="text-center">{{da.duration}}</td>
        <td class="text-center">{{da.numberOfResources}}</td>
        <td class="text-center">{{da.effortCapacity}}</td>
        <td class="text-center">{{da.effortPlanned}}</td>
        <td class="text-center">{{da.effortActual}}</td>
        <td class="text-center">{{da.effortRework}}</td>
        <td class="text-center">{{da.storyPlanned}}</td>
        <td class="text-center">{{da.storyBaselined}}</td>
        <td class="text-center">{{da.storyDelivered}}</td>
        <td class="text-center">{{da.storyAccepted}}</td>
        <td class="text-center">{{da.storyQATested}}</td>
        <td class="text-center">{{da.storyModified}}</td>
        <td class="text-center">{{da.storyPointPlanned}}</td>
        <td class="text-center">{{da.storyPointBaselined}}</td>
        <td class="text-center">{{da.storyPointDelivered}}</td>
        <td class="text-center">{{da.storyPointAccepted}}</td>
        <td class="text-center">{{da.codeReviewInternal}}</td>
        <td class="text-center">{{da.codeReviewExternal}}</td>
        <td class="text-center">{{da.defectQA}}</td>
        <td class="text-center">{{da.defectUAT}}</td>
        <td class="text-center">{{da.defectProduction}}</td>
        <td class="text-center">{{da.defectReopened}}</td>
        <td class="text-center">{{da.unitTestCoverage}}</td>
      </tr>
    </ng-template>
  </p-table>

  <p-accordion [activeIndex]="1">
    <p-accordionTab header="Plan">

      <div class="flex overflow-hidden">
        <div class="flex flex-none align-items-center  justify-content-center px-1">
          <p-dropdown appendTo="body" class="w-full" placeholder="Type" [options]="planType" optionLabel="name" optionValue="value" [showClear]="true" [(ngModel)]="sprintData.linkType">
          </p-dropdown>
        </div>

        <div class="flex flex-none align-items-center  justify-content-center px-1">
          <p-dropdown appendTo="body" class="w-full" placeholder="User" [options]="users" optionLabel="name" optionValue="uid" [showClear]="true" [(ngModel)]="sprintData.userKey">
          </p-dropdown>
        </div>
        <div class="flex-grow-1 flex align-items-center justify-content-center px-1">
          <input class="w-full" type="text" pInputText placeholder="What" [(ngModel)]="sprintData.activity.what" />
        </div>

        <div class="flex align-items-center justify-content-center px-1" style="flex: 0 0 100px">
          <input class="w-full" type="text" pInputText placeholder="User Story/Bug" [(ngModel)]="sprintData.linkKey" />
        </div>


        <div class="flex align-items-center justify-content-center px-1" style="flex: 0 0 50px">
          <p-inputNumber [inputStyle]="{'width':'60px','text-align':'right'}" mode="decimal" [minFractionDigits]="2"
                         [maxFractionDigits]="2" [min]="0" [max]="99.99" placeholder="Plan" [(ngModel)]="sprintData.activity.plan"> </p-inputNumber>
        </div>
        <!--<div class="flex flex-none align-items-center justify-content-center px-1">
          <p-inputNumber [inputStyle]="{'width':'60px','text-align':'right'}" mode="decimal" [minFractionDigits]="2" [maxFractionDigits]="2" [min]="0" [max]="99.99" placeholder="Actual"> </p-inputNumber>
        </div>-->
        <div class="flex-none flex align-items-center justify-content-center pl-1 pr-2 py-2">
          <p-button icon="pi pi-plus" (click) ="addActivity()"></p-button>
        </div>
      </div>

      <div class="flex flex-row flex-wrap">
        <div class="flex-1 m-2">
          <p-table [value]="stories" styleClass="p-datatable-sm" [scrollable]="true" scrollHeight="200px">
            <ng-template pTemplate="header" let-columns>
              <tr>
                <th>Story</th>
                <th>Points</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-story>
              <tr>
                <td>{{story.id}}</td>
                <td>{{story.storyPoints}}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="flex-1 m-2">
          <p-table [value]="project.bugs" styleClass="p-datatable-sm" [scrollable]="true" scrollHeight="200px">
            <ng-template pTemplate="header" let-columns>
              <tr>
                <th>ID</th>
                <th>RCA</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-bug>
              <tr>
                <td>{{bug.id}}</td>
                <td>{{bug.rca}}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="flex-1 m-2"></div>
      </div>
    </p-accordionTab>

    <p-accordionTab *ngFor="let user of project.users">
      <ng-template pTemplate="header">
        <div class="flex-grow-1 flex align-items-center">{{user.name}}</div>
      </ng-template>
      <ng-template pTemplate="content">

        <p-tabView>
          <p-tabPanel header="Yesterday - {{user.yesterdayActivities.length}} / {{effort(user.yesterdayActivities)}}">
            <div class="flex flex-row-reverse w-full">
              <p-button label="Close Day" icon="pi pi-lock" iconPos="right" (click)="closeDay(user)"></p-button>
            </div>
            <app-activity [for]="'yesterday'" (addWork)="addTask($event, user.yesterdayActivities)"></app-activity>
            <app-activities [activities]="user.yesterdayActivities" [for]="'yesterday'"></app-activities>
          </p-tabPanel>
          <p-tabPanel header="Today - {{user.activities.length}}">
            <app-activity [for]="'today'" (addWork)="addTask($event, user.activities)"></app-activity>
            <app-activities [activities]="user.activities" [for]="'today'"></app-activities>
          </p-tabPanel>
          <p-tabPanel header="Future - {{user.futureActivities.length}}">
            <app-activity [for]="'future'" (addWork)="addTask($event, user.futureActivities)"></app-activity>
            <app-activities [activities]="user.futureActivities" [for]="'future'"></app-activities>
          </p-tabPanel>

        </p-tabView>
      </ng-template>
    </p-accordionTab>
  </p-accordion>
</div>
